{% extends "base.html" %} {% load static %} {% block UserName %} {{ UserName}}
{% endblock %} {% block Title %} REPORTS {% endblock %} {% block functionTitle%}MISSING ATTENDANCE RECORDS{% endblock %} {% block content %}

<div >

    <div class="row">
        <div class="col-lg-12">
            <div class="card" id="orderList">
                <div class="card-header border-0">
                    <div class="row align-items-center gy-3">
                        <div class="col-sm">
                            <h5 class="card-title mb-0">Missing attendance records</h5>
                        </div>
                       
                    </div>
                </div>
                <div class="card-body border border-dashed border-end-0 border-start-0">
                    <form>
                        <div class="row g-3">
                            <div class="col-xxl-5 col-sm-6">
                                <div>
                                    <input type="text" id="childID" class="form-control" placeholder="Child name..." list="children">
                                    <datalist id='children'></datalist>
                                </div>
                            </div>
                            <!--end col-->
                            <div class="col-xxl-2 col-sm-6">
                                <div>
                                    <input type="text" class="form-control" data-provider="flatpickr" data-date-format="d M, Y" data-range-date="true" id="from_date" placeholder="From date">
                                </div>
                            </div>

                            <div class="col-xxl-2 col-sm-6">
                                <div>
                                    <input type="text" class="form-control" data-provider="flatpickr" data-date-format="d M, Y" data-range-date="true" id="to_date" placeholder="To date">
                                </div>
                            </div>

                            <!--end col-->
                            
                            <div class="col-xxl-1 col-sm-4">
                                <div>
                                    <button type="button" class="btn btn-primary w-100" > 
                                        Search
                                    </button>
                                </div>
                            </div>
                            <!--end col-->
                        </div>
                        <!--end row-->
                    </form>
                </div>
                <div class="card-body pt-0">
                    <div>
                        <div class="form-check"></div>
                        
                        <table id="missingRecordsTable" class="table table-striped table-hover" cellspacing="0">
                            <thead>
                              <tr>
                                <th>Child</th>
                                <th>Date</th>
                                <th>Time</th>
                               
                              </tr>
                            </thead>
                          </table>
                        
                    </div>
                    <div class="modal fade" id="showModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header bg-light p-3">
                                    <h5 class="modal-title" id="exampleModalLabel">&nbsp;</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="close-modal"></button>
                                </div>
                                <form class="tablelist-form" autocomplete="off">
                                    <div class="modal-body">
                                        <input type="hidden" id="id-field">

                                        <div class="mb-3" id="modal-id">
                                            <label for="orderId" class="form-label">ID</label>
                                            <input type="text" id="orderId" class="form-control" placeholder="ID" readonly="">
                                        </div>

                                        <div class="mb-3">
                                            <label for="customername-field" class="form-label">Customer Name</label>
                                            <input type="text" id="customername-field" class="form-control" placeholder="Enter name" required="">
                                        </div>

                                        

                                        <div class="mb-3">
                                            <label for="date-field" class="form-label">Order Date</label>
                                            <input type="date" id="date-field" class="form-control" data-provider="flatpickr" required="" data-date-format="d M, Y" data-enable-time="" placeholder="Select date">
                                        </div>

                                        <div class="row gy-4 mb-3">
                                            <div class="col-md-6">
                                                <div>
                                                    <label for="amount-field" class="form-label">Amount</label>
                                                    <input type="text" id="amount-field" class="form-control" placeholder="Total amount" required="">
                                                </div>
                                            </div>
                                            
                                        </div>

                                        
                                    </div>
                                  
                                </form>
                            </div>
                        </div>
                    </div>

                    
                </div>
            </div>

        </div>
        <!--end col-->
    </div>
    <!--end row-->

</div>


{% endblock %}  {% block scripts %}
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<!--datatable js-->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>

<script src="{% static 'assets/js/pages/datatables.init.js' %}"></script>
<script src="{% static 'assets/libs/node-waves/waves.min.js' %}"></script>
<script src="{% static 'assets/libs/feather-icons/feather.min.js' %}"></script>
<!-- flatpickr -->
<script src="{% static 'assets/libs/flatpickr/flatpickr.min.js' %}"></script>
<script src="{% static 'assets/libs/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'assets/libs/simplebar/simplebar.min.js' %}"></script>

<script>
  var $ = jQuery;
  var id;
  var dataTable;

  jQuery(document).ready(function () {

    jQuery('#date_logged').flatpickr({
                minDate: new Date().fp_incr(-30), 
                maxDate:  "today",
                
            });

// Load the Child into the text box
jQuery.ajax({
      type: "GET",
      url: "{% url 'core:view_child_j' %}",
      beforeSend: function () {},
      success: function (response) {
        console.log(response);
        for (var i in response) {
            child = response[i];
            jQuery("#children").append(`<option value="${child.admission_number}">${child.child_first_name + " - " + child.child_last_name}</option>`);
          }
      },
      error: function (xhr, textStatus, errorThrown) {
        alert("Error: " + xhr.status + ", " + xhr.statusText);
      },
    });


    window.setTimeout(function () {
      // Select the inner div with the class "alert" inside the outer div with class "flex-shrink-0"
      var alertDiv = jQuery(".alert");

      // Check if the inner div contains a success message
      var successMessageFound = alertDiv.find(".alert-success").length > 0;

      // If a success message is found, apply the fade-out effect
      if (successMessageFound) {
        alertDiv.fadeTo(1000, 0).slideUp(1000, function () {
          jQuery(this).remove();
        });
      }
    }, 2000);

    var table = $("#missingRecordsTable").DataTable({
      responsive: true,
      dom: "Bfrtip",
            pageLength: 50,

            buttons: ["excel", "print"],
      order: [[1, "asc"]], // Set default sorting by admission_date in descending order
    });
  });



  jQuery("#time_logged").flatpickr({
    enableTime: true,
    noCalendar: true,
    enableSeconds: false,
    dateFormat: "H:i",
    allowInput: true,
  });

  jQuery("#showModal").on("hidden.bs.modal", function () {
    jQuery(this).find("form").trigger("reset");
  });

  var url = "";

  jQuery(document).on("click", ".link-success", function (e) {
    e.preventDefault();
    url = jQuery(this).attr("href");

    // Show the modal
    jQuery("#showUpdateModal").modal("show");

    // Load the form into the modal using AJAX
    jQuery.ajax({
      type: "GET",
      url: url,
      dataType: "html",
      success: function (data) {
        // Assuming you have a modal body with the id "updateModalBody"
        jQuery("#modelForm").html(data);
      },
      error: function (xhr, textStatus, errorThrown) {
        alert("Error: " + xhr.status + ", " + xhr.statusText);
      },
    });
  });

  jQuery(document).on("click", "#addRates", function (e) {
    e.preventDefault();
    url = jQuery(this).attr("href");
    id = jQuery(this).attr("data-id");

    // Show the modal
    jQuery("#rateModals").modal("show");

    // Load the form into the modal using AJAX
    jQuery.ajax({
      type: "GET",
      url: url,
      data: { rate_id: id },
      dataType: "html",
      success: function (data) {
        // Assuming you have a modal body with the id "updateModalBody"
        jQuery("#modelRateForm").html(data);
        jQuery("#effective_from").flatpickr();
      },
      error: function (xhr, textStatus, errorThrown) {
        alert("Error: " + xhr.status + ", " + xhr.statusText);
      },
    });
  });

  jQuery("secondButton").click(function () {
    window.parent.location = window.parent.location.href;
  });

  jQuery(document).on("click", "#additionalLink", function (e) {
    dataTable.clear();
    id = jQuery(this).attr("data-id");
    jQuery.ajax({
      url: "{% url 'core:view_additional_rates_js' %}",
      type: "GET",
      data: { base_rate_id: id },
      beforeSend: function () {},
      success: function (response) {
        jQuery.each(response, function (i, item) {
          
          dataTable.row.add([
            response[i].slot_number_hour,
            response[i].extra_rate,
            response[i].effective_from,
            response[i].effective_to,
          ]);
        });

        dataTable.draw();
      },
      error: function (response) {
        console.log(response);
      },
    });
  });

  jQuery(document).on("click", "#historyLink", function (e) {
    dataTable.clear();
    id = jQuery(this).attr("data-id");
    jQuery.ajax({
      url: "{% url 'core:view_rates_rate_js' %}",
      type: "GET",
      data: { rate_id: id },
      beforeSend: function () {},
      success: function (response) {
        jQuery.each(response, function (i, item) {
          
          dataTable.row.add([
            response[i].standard_hourly_rate,
            response[i].effective_from,
            response[i].effective_to,
            response[i].is_active,
          ]);
        });

        dataTable.draw();
      },
      error: function (response) {
        console.log(response);
      },
    });
  });
  
  jQuery("#showModalCreate").on("hidden.bs.modal", function () {
        jQuery(this).find("form").trigger("reset");

    });

  


    // Add an event listener to the "to_time" field
        jQuery(document).on('change', '#to_time',function () {
            
            // Get the values of "from_time" and "to_time"
            var fromTime = jQuery('#from_time').val();
            var toTime = jQuery(this).val();
           

            // Make an Ajax request to calculate the duration
            jQuery.ajax({
                url: "{% url 'core:calculate_duration' %}",
                method: 'GET',
                data: {
                    'from_time': fromTime,
                    'to_time': toTime,
                },
                success: function (data) {
                    // Combine hours and minutes with a dot separator
                var durationFormatted = data.duration_hours + '.' + (data.duration_minutes < 10 ? '0' : '') + data.duration_minutes;

                    // Update the "no_hours" field with the formatted duration
                jQuery('#no_hours').val(durationFormatted);
                },
                error: function () {
                    console.error('Error calculating duration.');
                }
            });
        });

</script>

<!-- App js -->
<script src="{% static 'assets/js/app.js' %}"></script>

{% endblock %}
